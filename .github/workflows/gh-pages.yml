name: gh-pages

on: 
  push:
    branches:
      - 'gh-pages'
      - 'githubactions-armada_*'
      
jobs:
  update-gh-pages:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2

      - name: Update gh-pages - Armada
        if: ${{ contains( github.ref, 'githubactions-armada_' )}}
        run: |  
          RELEASE_TAG=`git branch --show-current | sed 's/githubactions-armada_//'`
          hub pull-request --base "gh-pages" -m "Update Armada Chart to $RELEASE_TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update repo index
        if: ${{ contains( github.ref, 'gh-pages') }}
        run: |
          echo "${{ secrets.CLONE_KEY }}" > id_rsa
          chmod 400 id_rsa
          git remote -v

          helm repo index .
          git diff index.yaml
          git add index.yaml
          git -c user.name="Ljubo Nikolic" -c user.email="ljubonikolic@gmail.com" commit -qam "Updating index.yaml"
          ssh-agent bash -c 'ssh-add id_rsa; git push -q origin HEAD'
          echo "Remove key..." && rm -fv id_rsa